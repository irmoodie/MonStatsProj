---
title: "Centaurea Project"
author: "DG, IM, BS"
date: "29/03/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This is the Rmarkdown file for the Centaurea project containing the code required to replicate the analysis and the plots.

We begin by loading the required packages for the rest of the script.

```{r library, message = FALSE}
library(ggeffects)
library(gridExtra)
library(cowplot)
library(lme4)
library(tidyverse)

```

Next, we load in our dataset.

```{r data, message = FALSE}
data <- read_tsv("donnees_centauree.csv")

data <- data %>%
    mutate(light = PAR/reference) %>%
    rename("species" = "espece",
           "population" = "pop")

data$species <- factor(data$species, levels = c("mac", "cor"))

head(data)
```

We will now split the dataset into two part. The first part will be used to model the probability of germination, and the second part will be used to model the rosette size growth.

```{r datasplit, message=FALSE}

didnotgerm <- data %>%
  filter(is.na(Date_de_germination)) %>%
  mutate(Date_de_germination = 0)

didgerm <- data %>%
  filter(!is.na(Date_de_germination)) %>%
  mutate(Date_de_germination = 1)

germ_data <- full_join(didnotgerm, didgerm) %>%
  rename("germination" = "Date_de_germination") %>%
  select(-c(Cotyledons:reference))

rm(didnotgerm, didgerm)

head(germ_data)

rosette_data <- data %>%
    rename("2005-12-01" = "Taille_Dec_05",
         "2006-02-01" = "Taille_Fev_06",
         "2006-03-01" = "Taille_Mars_06",
         "2006-06-01" = "Taille_Juin_06",
         "2006-09-01" = "Taille_Sept_06") %>%
  gather(key = "Date", 
         value = "Rosette_size", 
         "2005-12-01":"2006-09-01") %>%
  select(-c(traitement:reference)) %>%
  group_by(Plante) %>%
  filter(Rosette_size == max(Rosette_size),
         Rosette_size > 0) %>%
  distinct(Plante, .keep_all = TRUE)

rosette_data$Date_de_germination <- as.Date(rosette_data$Date_de_germination, format = "%d/%m/%Y")
rosette_data$Date <- as.Date(rosette_data$Date, format = "%Y-%m-%d")

rosette_data <- rosette_data %>%
  mutate(time_after_germ = difftime(Date, Date_de_germination, units = "days")) %>%
  filter(time_after_germ > 0)

rosette_data$time_after_germ <- as.numeric(rosette_data$time_after_germ)
  
rm(data)

head(rosette_data)
  
```

Now, we will build and plot the germination model (we only show the final model selected).

```{r germ_mod, fig.align='center', fig.width=5, fig.height=5}

germ_mod <- glmer(germination~light*species+(1|species:population), data = germ_data, family = "binomial")

summary(germ_mod)

germ_pred <- ggpredict(germ_mod, terms = c("light [all]", "species"), type = "fixed") %>%
  rename("species" = "group")

germ_pred$species <- recode_factor(germ_pred$species, mac = "C. maculosa", cor = "C. corymbosa")

ggplot(data = germ_data,
       aes(x = light, y = germination)) +
  geom_point(data = germ_data %>%
               filter(species == "mac"),
             aes(x = light, y = germination),
             size = 3, alpha = 0.1, colour = "#F8766D") +
  geom_point(data = germ_data %>%
               filter(species == "cor"),
             aes(x = light, y = germination),
             size = 3, alpha = 0.1, colour = "#00BFC4") +
  geom_line(data = germ_pred,
            aes(y = predicted, x = x, colour = species),
            size = 1.5) +
  geom_ribbon(data = germ_pred, 
              aes(y = predicted, x = x, ymin = conf.low, ymax = conf.high, colour = species, fill = species),
              alpha = 0.1) +
  labs(y = "P(Germination)",
       x = "Light (received PAR / reference PAR)") +
  scale_x_continuous(breaks = c(0,0.25,0.5,0.75,1)) +
  theme_cowplot() +
  theme(legend.position = c(0.65,0.25),
        legend.title = element_blank())

rm(germ_pred, germ_mod)
```

And finally, we build and plot the model for rosette size.

```{r rosette_mod}

lm1 <- lm(Rosette_size~light*species*Cotyledons*time_after_germ, data = rosette_data)
summary(lm1)
lm2 <- update(lm1, .~. -light:species:Cotyledons:time_after_germ) # remove 4 way int
summary(lm2)
lm3 <- update(lm2, .~. -species:Cotyledons:time_after_germ) # remove non sig 3 way int
summary(lm3)
lm4 <- update(lm3, .~. -light:Cotyledons:time_after_germ) # remove non sig 3 way
summary(lm4)
lm5 <- update(lm4, .~. -light:species:Cotyledons)
summary(lm5)
lm6 <- update(lm5, .~. -Cotyledons:time_after_germ)
summary(lm6)
lm7 <- update(lm6, .~. -species:time_after_germ)
summary(lm7)
lm8 <- update(lm7, .~. -species:Cotyledons)
summary(lm8)
lm9 <- update(lm8, .~. -light:Cotyledons)
summary(lm9) # min. ad. mod.

plot(lm9)

rm(lm1,lm2,lm3,lm4,lm5,lm6,lm7,lm8)

```

```{r figures_rosette, fig.align='center',fig.width=15, message=FALSE, warning=FALSE}
rosette_pred1 <- ggpredict(lm9, terms = c("light", "species"),type = "fixed") %>%
  rename("species" = "group")

rosette_pred2 <- ggpredict(lm9, terms = c("Cotyledons", "species"),type = "fixed") %>%
  rename("species" = "group")

rosette_pred3 <- ggpredict(lm9, terms = c("time_after_germ", "species"),type = "fixed") %>%
  rename("species" = "group")

rosette_pred1$species <- recode_factor(rosette_pred1$species, mac = "C. maculosa", cor = "C. corymbosa")
rosette_pred2$species <- recode_factor(rosette_pred2$species, mac = "C. maculosa", cor = "C. corymbosa")
rosette_pred3$species <- recode_factor(rosette_pred3$species, mac = "C. maculosa", cor = "C. corymbosa")

A <- ggplot(data = rosette_data,
             aes(x = light, y = Rosette_size)) +
  geom_point(data = rosette_data %>%
               filter(species == "mac"),
             aes(x = light, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#F8766D") +
  geom_point(data = rosette_data %>%
               filter(species == "cor"),
             aes(x = light, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#00BFC4") +
  geom_line(data = rosette_pred1,
            aes(y = predicted, x = x, colour = species),
            size = 1.5) +
  geom_ribbon(data = rosette_pred1,
              aes(y = predicted, x = x, ymin = conf.low, ymax = conf.high, colour = species, fill = species),
              alpha = 0.1) +
  labs(y = "Maximum rosette size (mm)",
       x = "Light (received PAR / reference PAR)",
       title = "A") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,1.09)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0,150)) +
  theme_cowplot()+
  theme(legend.position = "none")

B <- ggplot(data = rosette_data,
             aes(x = Cotyledons, y = Rosette_size)) +
  geom_point(data = rosette_data %>%
               filter(species == "mac"),
             aes(x = Cotyledons, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#F8766D") +
  geom_point(data = rosette_data %>%
               filter(species == "cor"),
             aes(x = Cotyledons, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#00BFC4") +
  geom_line(data = rosette_pred2,
            aes(y = predicted, x = x, colour = species),
            size = 1.5) +
  geom_ribbon(data = rosette_pred2,
              aes(y = predicted, x = x, ymin = conf.low, ymax = conf.high, colour = species, fill = species),
              alpha = 0.1) +
  labs(y = "Maximum rosette size (mm)",
       x = "Cotyledon size (mm)",
       title = "B") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,26)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0,150)) +
  theme_cowplot() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position = "none",
        legend.title = element_blank())

C <- ggplot(data = rosette_data,
             aes(x = time_after_germ, y = Rosette_size)) +
  geom_point(data = rosette_data %>%
               filter(species == "mac"),
             aes(x = time_after_germ, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#F8766D") +
  geom_point(data = rosette_data %>%
               filter(species == "cor"),
             aes(x = time_after_germ, y = Rosette_size),
             size = 3, alpha = 0.3, colour = "#00BFC4") +
  geom_line(data = rosette_pred3,
            aes(y = predicted, x = x, colour = species),
            size = 1.5) +
  geom_ribbon(data = rosette_pred3,
              aes(y = predicted, x = x, ymin = conf.low, ymax = conf.high, colour = species, fill = species),
              alpha = 0.1) +
  labs(y = "Maximum rosette size (mm)",
       x = "Time after germination (days)",
       title = "C") +
  scale_x_continuous(expand = c(0, 0), limits = c(0,325)) + 
  scale_y_continuous(expand = c(0, 0), limits = c(0,150)) +
  theme_cowplot() +
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        legend.position = c(0.1,0.9),
        legend.title = element_blank())

grid.arrange(A,B,C, ncol = 3, nrow = 1)

rm(A, B, C, rosette_mod, rosette_pred1, rosette_pred2, rosette_pred3)
```

